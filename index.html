<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统控制台 - 修仙世界操纵者</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #e5e4e0; /* 莫兰迪灰米色 */
            color: #4d4d4d; /* 莫兰迪深灰 */
            overflow: hidden;
            height: 100vh;
        }
        .status-bar {
            height: 60px;
            background: linear-gradient(90deg, #b7b5ac 0%, #e5e4e0 100%);
            border-bottom: 2px solid #4d4d4d;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .system-level { display: flex; align-items: center; gap: 15px; }
        .level-badge {
            background: #4d4d4d; /* 莫兰迪灰紫 */
            color: #f6f5f3;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        .exp-bar {
            width: 200px; height: 10px;
            background: #d3d2ce;
            border-radius: 5px; overflow: hidden;
        }
        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4d4d4d, #7a8a99); /* 灰紫到灰绿 */
            width: 65%;
            transition: width 0.3s ease;
        }
        .status-indicators {
            display: flex;
            flex-direction: row;
            gap: 30px;
            width: auto;
            justify-content: flex-end;
            align-items: center;
            overflow: visible;
        }
        .indicator {
            text-align: center;
            min-width: unset;
        }
        .indicator-label { font-size: 12px; opacity: 0.7; }
        .indicator-value { font-size: 24px; font-weight: bold; }
        .trust-meter { color: #7a8a99; font-weight: bold; text-shadow: 0 1px 2px #fff8; } /* 深绿色，提升可读性 */
        .backlash-meter { color: #bfa782; } /* 莫兰迪奶咖 */
        .points-display {
            background: rgba(163, 177, 167, 0.10); /* 莫兰迪灰绿 */
            border: 1px solid #7a8a99;
            padding: 10px 20px;
            border-radius: 5px;
        }
        .tab-bar {
            display: flex; justify-content: center; align-items: center;
            background: linear-gradient(90deg, #b7b5ac 0%, #e5e4e0 100%);
            border-bottom: 2px solid #4d4d4d;
            height: 48px;
        }
        .tab-btn {
            background: none; border: none;
            color: #7a8a99;
            font-size: 18px; padding: 10px 32px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            border-radius: 8px 8px 0 0;
            margin: 0 8px; outline: none;
        }
        .tab-btn.active, .tab-btn:hover {
            background: #7a8a99;
            color: #f6f5f3;
        }
        .tab-content {
            width: 90vw; max-width: 1200px; margin: 24px auto 0 auto;
            background: rgba(183, 181, 172, 0.15); /* 莫兰迪灰米色 */
            border: 1.5px solid #4d4d4d;
            border-radius: 10px;
            min-height: 70vh; max-height: calc(100vh - 60px - 48px - 32px);
            box-shadow: 0 0 24px #4d4d4d40;
            overflow-y: auto; overflow-x: hidden;
            padding: 32px 32px 24px 32px;
            position: relative; -webkit-overflow-scrolling: touch;
        }
        .left-panel, .center-panel, .right-panel { width: 100% !important; background: none; border: none; padding: 0; overflow: visible; }
        .left-panel .tool-section, .right-panel .tool-section { margin-bottom: 30px; }
        .section-title {
            color: #4d4d4d;
            margin-bottom: 15px; font-size: 18px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .tool-button {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: rgba(163, 177, 167, 0.10);
            border: 1px solid #7a8a99;
            color: #6d7b6d;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .tool-button:hover {
            background: rgba(163, 177, 167, 0.25);
            transform: translateX(5px);
        }
        .tool-button.locked {
            opacity: 0.3; cursor: not-allowed;
            border-color: #b7b5ac; color: #b7b5ac;
        }
        .tool-button.danger {
            border-color: #bfa782;
            color: #bfa782;
        }
        .scene-window {
            background: rgba(183, 181, 172, 0.25);
            border: 1px solid #4d4d4d;
            padding: 20px; margin-bottom: 20px; border-radius: 5px;
        }
        .scene-title { color: #222; margin-bottom: 10px; font-size: 20px; font-weight: bold; text-shadow: 0 1px 2px #fff8, 0 0 1px #4d4d4d; }
        .scene-description { color: #4d4d4d; line-height: 1.6; margin-bottom: 15px; }
        .protagonist-thoughts {
            background: rgba(191, 167, 130, 0.10);
            padding: 15px;
            border-left: 3px solid #bfa782;
            margin: 15px 0;
            font-style: italic;
            color: #7a6a55;
            font-weight: bold;
            text-shadow: 0 1px 2px #fff8;
        }
        .choice-preview { margin-top: 20px; }
        .choice-option {
            background: rgba(163, 177, 167, 0.05);
            border: 1px solid #7a8a99;
            padding: 15px; margin-bottom: 10px;
            cursor: pointer; position: relative;
            transition: all 0.3s ease;
        }
        .choice-option:hover {
            background: rgba(163, 177, 167, 0.15);
        }
        .choice-text { color: #4d4d4d; margin-bottom: 5px; }
        .choice-consequences {
            font-size: 14px;
            color: #222;
            opacity: 1;
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        .trust-impact { position: absolute; right: 15px; top: 15px; font-weight: bold; }
        .trust-positive { color: #7a8a99; }
        .trust-negative { color: #bfa782; }
        .npc-thoughts {
            background: rgba(176, 174, 177, 0.20);
            border: 1px solid #4d4d4d;
            padding: 15px; margin-bottom: 15px; border-radius: 5px;
        }
        .npc-name { color: #4d4d4d; font-weight: bold; margin-bottom: 5px; }
        .npc-thought { color: #4d4d4d; font-size: 14px; font-style: italic; }
        .hidden-info {
            background: rgba(191, 167, 130, 0.10);
            border: 1px solid #bfa782;
            padding: 10px; margin-bottom: 10px; font-size: 14px;
        }
        .world-event {
            background: rgba(163, 177, 167, 0.10);
            border-left: 3px solid #7a8a99;
            padding: 10px; margin-bottom: 10px; font-size: 14px;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #d3d2ce; }
        ::-webkit-scrollbar-thumb { background: #4d4d4d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7a8a99; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes dataflow { 0% { transform: translateY(0); } 100% { transform: translateY(100px); } }
        .data-stream {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.08;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="20" font-size="10" fill="%23b0aeb1" opacity="0.5">01001010</text></svg>');
            animation: dataflow 20s linear infinite;
        }
        @media (max-width: 900px) {
            .tab-content { width: 98vw; max-width: 100vw; padding: 12px 4vw 16px 4vw; font-size: 15px; }
            .tab-bar { height: 44px; }
            .tab-btn { font-size: 15px; padding: 8px 10px; margin: 0 2px; }
            .scene-title { font-size: 17px; }
            .section-title { font-size: 15px; }
            .tool-button { font-size: 13px; padding: 10px; }
        }
        @media (max-width: 600px) {
            .tab-content { width: 100vw; max-width: 100vw; min-height: 60vh; max-height: none; padding: 8px 2vw 12px 2vw; font-size: 13px; }
            .tab-bar { height: 40px; }
            .tab-btn { font-size: 13px; padding: 6px 4px; }
            .scene-title { font-size: 15px; }
            .section-title { font-size: 13px; }
            .tool-button { font-size: 12px; padding: 8px; }
        }
        .tab-content::-webkit-scrollbar { width: 8px; background: #d3d2ce; }
        .tab-content::-webkit-scrollbar-thumb { background: #4d4d4d; border-radius: 4px; }
        .tab-content::-webkit-scrollbar-thumb:hover { background: #7a8a99; }
        .tab-content { scrollbar-width: thin; scrollbar-color: #4d4d4d #d3d2ce; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(183,181,172,0.85); z-index: 1000;
        }
        .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #f6f5f3;
            border: 2px solid #4d4d4d;
            padding: 30px; border-radius: 10px; min-width: 400px;
        }
        .modal-title { color: #4d4d4d; font-size: 24px; margin-bottom: 20px; }
        .modal-body { color: #4d4d4d; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    /* 商城商品莫兰迪色全局覆盖 */
    .shop-item {
        background: rgba(176,174,177,0.10) !important;
        border: 1px solid #7a8a99 !important;
        border-radius: 5px !important;
    }
    .shop-item h4 {
        color: #7a8a99 !important;
        font-weight: 500 !important;
        font-size: 17px !important;
    }
    .shop-item p {
        color: #4d4d4d !important;
    }
    .shop-item span {
        color: #bfa782 !important;
        font-weight: 500 !important;
    }
    .shop-item .tool-button,
    .shop-item .tool-button.locked {
        color: #7a8a99 !important;
        border-color: #7a8a99 !important;
        background: rgba(176,174,177,0.15) !important;
    }
    .shop-item .tool-button.locked {
        color: #b7b5ac !important;
        border-color: #b7b5ac !important;
        opacity: 0.5 !important;
    }
    /* “上架新商品”按钮柔和色 */
    button.tool-button[onclick*="showAddProductModal"] {
        color: #7a8a99 !important;
        background: rgba(176,174,177,0.15) !important;
        border-color: #7a8a99 !important;
        font-weight: 400 !important;
    }
    /* 红色商品柔和处理 */
    .shop-item[style*="255,100,100"], .shop-item[style*="ff6666"] h4, .shop-item[style*="ff6666"] span {
        color: #bfa782 !important;
        border-color: #bfa782 !important;
        background: rgba(191,167,130,0.10) !important;
    }
    /* 移动端弹窗适配 + 状态栏自适应 */
    @media (max-width: 700px) {
        .status-bar {
            flex-direction: column !important;
            align-items: flex-start !important;
            height: auto !important;
            padding: 6px 6vw 6px 6vw !important;
            gap: 6px !important;
        }
        .system-level {
            flex-direction: row !important;
            gap: 8px !important;
            width: 100% !important;
            margin-bottom: 2px !important;
        }
        .exp-bar {
            width: 100px !important;
            height: 8px !important;
        }
        .status-indicators {
            flex-direction: row !important;
            gap: 10px !important;
            width: 100% !important;
            justify-content: flex-start !important;
            overflow-x: auto !important;
            margin-top: 2px !important;
        }
        .indicator {
            min-width: 70px !important;
        }
        .indicator-label {
            font-size: 11px !important;
        }
        .indicator-value {
            font-size: 18px !important;
        }
        .points-display {
            padding: 6px 10px !important;
            font-size: 13px !important;
        }
        .modal-content {
            width: 96vw !important;
            min-width: unset !important;
            max-width: 100vw !important;
            padding: 16px !important;
            box-sizing: border-box;
        }
        .modal-title {
            font-size: 18px !important;
            margin-bottom: 12px !important;
        }
        .modal-body {
            font-size: 15px !important;
            padding: 0 !important;
        }
        .modal-actions {
            flex-direction: column;
            gap: 8px !important;
        }
        .modal-content[style] {
            min-width: unset !important;
            width: 96vw !important;
            max-width: 100vw !important;
            padding: 16px !important;
        }
        .modal-content {
            max-height: 90vh !important;
            overflow-y: auto !important;
        }
        /* 针对弹窗内表单控件 */
        .modal-content input,
        .modal-content textarea,
        .modal-content select {
            font-size: 15px !important;
            padding: 8px !important;
        }
        .modal-content label {
            font-size: 14px !important;
        }
    }
    </style>
</head>
<body>
    <div class="data-stream"></div>
    <div class="status-bar">
        <div class="system-level">
            <div class="level-badge">系统 Lv.3</div>
            <div class="exp-bar"><div class="exp-fill"></div></div>
            <span style="font-size: 12px; opacity: 0.7;">2450/5000 EXP</span>
        </div>
        <div class="status-indicators">
            <div class="indicator">
                <div class="indicator-label">主角信任度</div>
                <div class="indicator-value trust-meter">78%</div>
            </div>
            <div class="indicator">
                <div class="indicator-label">世界反噬值</div>
                <div class="indicator-value backlash-meter">⚠ 45</div>
            </div>
            <div class="indicator points-display">
                <div class="indicator-label">可用积分</div>
                <div class="indicator-value">12,500</div>
            </div>
        </div>
    </div>
    <div class="tab-bar">
        <button class="tab-btn" data-tab="left">工具面板</button>
        <button class="tab-btn active" data-tab="center">主角窗口</button>
        <button class="tab-btn" data-tab="right">全知面板</button>
    </div>
    <div class="tab-content">
        <!-- 工具面板 -->
        <div class="left-panel tab-panel" data-tab="left" style="display: none;">
            <div class="tool-section">
                <h3 class="section-title">信息操控</h3>
                <button class="tool-button" onclick="showInfoControl()">透露信息</button>
                <button class="tool-button" onclick="hideInfo()">隐藏真相</button>
                <button class="tool-button danger" onclick="mislead()">误导主角</button>
                <button class="tool-button" onclick="staySilent()">保持沉默</button>
            </div>
            <div class="tool-section">
                <h3 class="section-title">系统干预</h3>
                <button class="tool-button" onclick="viewStats()">查看属性</button>
                <button class="tool-button" onclick="openShop()">打开商城</button>
<button class="tool-button" id="memoryEditBtn">记忆编辑</button>
                <button class="tool-button" onclick="materialize()">实体化</button>
            </div>
            <div class="tool-section">
                <h3 class="section-title">快捷操作</h3>
                <button class="tool-button" onclick="openTaskList()">任务列表</button>
                <button class="tool-button" onclick="checkAnchors()">时间锚点</button>
                <button class="tool-button" onclick="viewLogs()">系统日志</button>
            </div>
        </div>
        <!-- 主角窗口 -->
        <div class="center-panel tab-panel" data-tab="center" style="display: block;">
            <div class="scene-window">
                <h2 class="scene-title">【青云宗·外门广场】</h2>
                <div class="scene-description">
                    晨雾缭绕的广场上，数百名外门弟子正在晨练。主角站在人群边缘，看着远处内门的方向若有所思。
                    一个身影正快速接近——是外门管事李长风。
                </div>
                <div class="protagonist-thoughts">
                    💭 主角内心：「李长风突然找我，难道是因为昨天我展现的剑法？不，我明明已经刻意隐藏了实力...」
                </div>
                <div class="npc-dialogue" style="background: rgba(0,100,200,0.1); padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong style="color: #4d4d4d;">李长风：</strong>
                    <span style="color: #222; font-weight: 500;">"林凡，掌门有令，让你即刻前往主峰大殿。记住，问什么答什么，不要多说。"</span>
                </div>
                <div class="choice-preview">
                    <h3 style="color: #4d4d4d; margin-bottom: 15px; font-weight: bold;">主角选择预览：</h3>
                    <div class="choice-option" onclick="handleChoice(1)">
                        <div class="choice-text">1. "是，弟子这就前往。"</div>
                        <div class="choice-consequences">→ 顺从表现，降低怀疑 | 可能错过重要信息</div>
                        <span class="trust-impact trust-positive">信任度 +5</span>
                    </div>
                    <div class="choice-option" onclick="handleChoice(2)">
                        <div class="choice-text">2. "敢问管事，掌门召见所为何事？"</div>
                        <div class="choice-consequences">→ 可能获得线索 | 显得过于机警</div>
                        <span class="trust-impact trust-negative">信任度 -2</span>
                    </div>
                    <div class="choice-option" onclick="handleChoice(3)">
                        <div class="choice-text">3. "我需要准备什么吗？这是否与昨日之事有关？"</div>
                        <div class="choice-consequences">→ 暴露知情 | 李长风怀疑值 +15</div>
                        <span class="trust-impact trust-negative">信任度 -8</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- 全知面板 -->
        <div class="right-panel tab-panel" data-tab="right" style="display: none;">
            <div class="tool-section">
                <h3 class="section-title">NPC真实想法</h3>
                <div class="npc-thoughts">
                    <div class="npc-name">李长风 [怀疑度: 35%]</div>
                    <div class="npc-thought">
                        "这小子昨天那一剑...绝不是外门弟子该有的造诣。掌门突然召见，恐怕也是察觉到了什么。我得小心观察他的反应。"
                    </div>
                </div>
                <div class="npc-thoughts">
                    <div class="npc-name">暗中观察者 - 内门执事赵明</div>
                    <div class="npc-thought">
                        "有意思，掌门竟然亲自召见一个外门弟子。看来我的情报没错，这个林凡确实有古怪。"
                    </div>
                </div>
            </div>
            <div class="tool-section">
                <h3 class="section-title">隐藏信息</h3>
                <div class="hidden-info">
                    <strong>🔴 机密：</strong>掌门已经通过天机推演发现主角身负异宝，此次召见是一次试探。
                </div>
                <div class="hidden-info">
                    <strong>🔴 危险：</strong>魔门间谍已潜入青云宗，正在寻找身负"天道种子"之人。
                </div>
            </div>
            <div class="tool-section">
                <h3 class="section-title">世界暗流</h3>
                <div class="world-event">
                    <strong>【妖族动向】</strong><br>
                    白泽一脉正在集结力量，三日后将有大动作。
                </div>
                <div class="world-event">
                    <strong>【皇族密令】</strong><br>
                    三皇子已派出密探调查各大宗门天才弟子。
                </div>
                <div class="world-event">
                    <strong>【天机异动】</strong><br>
                    天机阁检测到命运线出现扰动，源头指向青云宗。
                </div>
            </div>
            <div class="tool-section">
                <h3 class="section-title">因果预测</h3>
                <div style="background: rgba(255,255,0,0.1); padding: 15px; border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <strong>选择1后果：</strong>安全通过，但错过获知掌门真实意图的机会
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>选择2后果：</strong>李长风会透露"与你的天赋有关"
                    </div>
                    <div>
                        <strong>选择3后果：</strong>触发李长风警觉事件，可能导致后续监视
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 信息控制弹窗 -->
    <div id="infoControlModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">信息透露控制</h2>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">选择要告诉主角的信息：</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="info1">
                        <span>李长风对你有所怀疑（低价值信息）</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="info2">
                        <span>掌门此次召见是为了试探你（中价值信息）</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="info3">
                        <span>掌门已知你身负异宝（高价值信息）</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="info4">
                        <span>宗门内有魔门间谍（危险信息）</span>
                    </label>
                </div>
                <div style="margin-top: 20px; padding: 10px; background: rgba(255,170,0,0.2); border-radius: 5px;">
                    <strong>预计影响：</strong>
                    <div id="infoImpact">请选择要透露的信息</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="confirmInfoReveal()">确认透露</button>
                <button class="tool-button" onclick="closeModal('infoControlModal')">取消</button>
            </div>
        </div>
    </div>
    <!-- 商城弹窗 -->
    <div id="shopModal" class="modal">
        <div class="modal-content" style="min-width: 600px;">
            <h2 class="modal-title">系统商城 - 后台控制</h2>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="shop-item" style="background: rgba(0,255,136,0.1); padding: 15px; border: 1px solid #00ff88; border-radius: 5px;">
                        <h4 style="color: #00ff88;">洞察符</h4>
                        <p style="font-size: 14px; margin: 10px 0;">查看NPC好感度</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>500积分</span>
                            <button class="tool-button" style="padding: 5px 10px;" onclick="setPrice('item1')">改价</button>
                        </div>
                    </div>
                    <div class="shop-item" style="background: rgba(0,255,136,0.1); padding: 15px; border: 1px solid #00ff88; border-radius: 5px;">
                        <h4 style="color: #00ff88;">记忆模糊丹</h4>
                        <p style="font-size: 14px; margin: 10px 0;">让NPC忘记一件小事</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>2000积分</span>
                            <button class="tool-button" style="padding: 5px 10px;" onclick="setPrice('item2')">改价</button>
                        </div>
                    </div>
                    <div class="shop-item" style="background: rgba(255,100,100,0.1); padding: 15px; border: 1px solid #ff6666; border-radius: 5px;">
                        <h4 style="color: #ff6666;">命运偏移卡</h4>
                        <p style="font-size: 14px; margin: 10px 0;">改变一次剧情走向</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>10000积分</span>
                            <button class="tool-button locked" style="padding: 5px 10px;">未解锁</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,0,0.1); border-radius: 5px;">
                    <strong>商城操作：</strong>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="tool-button" onclick="createSale()">制造限时优惠</button>
                        <button class="tool-button" onclick="hideItems()">隐藏部分商品</button>
                        <button class="tool-button danger" onclick="createFakeUrgency()">制造缺货假象</button>
                        <button class="tool-button" onclick="showAddProductModal()" style="background:rgba(0,255,136,0.15);color:#00ff88;">上架新商品</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="closeModal('shopModal')">关闭</button>
            </div>
        </div>
    </div>
    <!-- 编辑商品弹窗 -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="min-width:400px;">
            <h2 class="modal-title">编辑商品</h2>
            <div class="modal-body">
                <div style="margin-bottom:10px;">
                    <label>商品名称</label>
                    <input type="text" id="editProductName" style="width:100%;padding:8px;background:#222;border:1px solid #666;color:#aaa;" readonly>
                </div>
                <div style="margin-bottom:10px;">
                    <label>功能/描述</label>
                    <input type="text" id="editProductDesc" style="width:100%;padding:8px;background:#222;border:1px solid #666;color:#aaa;" readonly>
                </div>
                <div style="margin-bottom:10px;">
                    <label>积分价格</label>
                    <input type="number" id="editProductPrice" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>库存数量</label>
                    <input type="number" id="editProductStock" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="saveEditProduct()">保存</button>
                <button class="tool-button" onclick="closeModal('editProductModal')">取消</button>
            </div>
        </div>
    </div>
                    </div>
                </div>
            </div>
    <!-- 上架商品弹窗 -->
    <div id="addProductModal" class="modal">
        <div class="modal-content" style="min-width:400px;">
            <h2 class="modal-title">上架新商品</h2>
            <div class="modal-body">
                <div style="margin-bottom:15px;">
                    <label>商品名称</label>
                    <input type="text" id="productName" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;">
                </div>
                <div style="margin-bottom:15px;">
                    <label>功能/描述</label>
                    <input type="text" id="productDesc" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;" placeholder="如：提升属性、特殊效果等">
                </div>
                <div style="margin-bottom:15px;">
                    <label>积分价格</label>
                    <input type="number" id="productPrice" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;">
                </div>
                <div style="margin-bottom:15px;">
                    <label>库存数量</label>
                    <input type="number" id="productStock" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="addProduct()">确认上架</button>
                <button class="tool-button" onclick="closeModal('addProductModal')">取消</button>
            </div>
        </div>
    </div>
    <!-- 其它弹窗如任务编辑器、时间锚点、系统日志等由JS动态创建 -->
    <!-- 记忆编辑弹窗 -->
    <div id="memoryEditModal" class="modal">
        <div class="modal-content" style="min-width:400px;">
            <h2 class="modal-title">记忆编辑</h2>
            <div class="modal-body">
                <div style="margin-bottom:15px;">
                    <label>选择NPC</label>
                    <select id="memoryNpc" style="width:100%;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;">
                        <option value="李长风">李长风</option>
                        <option value="赵明">赵明</option>
                        <option value="主角">主角</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label>记忆内容</label>
                    <textarea id="memoryContent" style="width:100%;height:80px;padding:8px;background:#1a1a1a;border:1px solid #00ff88;color:#fff;" placeholder="请输入要编辑的记忆内容"></textarea>
                </div>
                <div style="color:#ffaa00;font-size:13px;margin-bottom:10px;">
                    消耗：<span id="memoryEditCost"></span> 积分
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="memoryEditSave()">保存</button>
                <button class="tool-button" onclick="closeModal('memoryEditModal')">取消</button>
            </div>
        </div>
    </div>
<!-- 已删除多余的重复记忆编辑弹窗，避免id冲突和结构混乱 -->
    <script>
    // 系统等级（可根据实际情况动态赋值）
    let systemLevel = 3; // 例：3级，后续可接入实际等级

    // 获取折扣后积分
    function getDiscountedCost(baseCost) {
        if (systemLevel >= 10) return Math.floor(baseCost * 0.5);
        if (systemLevel >= 7) return Math.floor(baseCost * 0.7);
        if (systemLevel >= 5) return Math.floor(baseCost * 0.8);
        if (systemLevel >= 3) return Math.floor(baseCost * 0.9);
        return baseCost;
    }

    // 动态刷新系统干预消耗显示
    function updateInterventionCosts() {
        if(document.getElementById('hintCost')) {
            document.getElementById('hintCost').textContent = '消耗: ' + getDiscountedCost(100) + '积分';
        }
        if(document.getElementById('truthCost')) {
            document.getElementById('truthCost').textContent = '消耗: ' + getDiscountedCost(500) + '积分 | 反噬+10';
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        updateInterventionCosts();
    });

    // 系统干预功能实现
    function provideHint() {
        const cost = getDiscountedCost(100);
        if(confirm(`确定消耗${cost}积分提供提示？`)) {
            if(typeof updatePoints === 'function') updatePoints(-cost);
            alert('已为主角提供提示！');
        }
    }
    function revealTruth() {
        const cost = getDiscountedCost(500);
        if(confirm(`确定消耗${cost}积分并增加10反噬揭示真相？`)) {
            if(typeof updatePoints === 'function') updatePoints(-cost);
            if(typeof updateBacklash === 'function') updateBacklash(10);
            alert('真相已揭示！');
        }
    }
    function memoryEdit() {
        const cost = getDiscountedCost(2000);
        if(confirm(`确定消耗${cost}积分进行记忆编辑？`)) {
            if(typeof updatePoints === 'function') updatePoints(-cost);
            alert('记忆编辑已执行（演示效果）');
        }
    }
    function materialize() {
        const cost = getDiscountedCost(10000);
        if(confirm(`确定消耗${cost}积分进行实体化？`)) {
            if(typeof updatePoints === 'function') updatePoints(-cost);
            alert('实体化已执行（演示效果）');
        }
    }

    // 覆盖暂停时间功能消耗
        // tab切换
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const tab = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-panel').forEach(panel => {
                        panel.style.display = (panel.getAttribute('data-tab') === tab) ? 'block' : 'none';
                    });
                });
            });
            // 初始化商城商品渲染
            renderShopItems();
        });

        // 商城商品数据（初始商品）
        let shopProducts = [
            { name: '洞察符', desc: '查看NPC好感度', price: 500, stock: 99, color: '#00ff88', border: '#00ff88', bg: 'rgba(0,255,136,0.1)' },
            { name: '记忆模糊丹', desc: '让NPC忘记一件小事', price: 2000, stock: 50, color: '#00ff88', border: '#00ff88', bg: 'rgba(0,255,136,0.1)' },
            { name: '命运偏移卡', desc: '改变一次剧情走向', price: 10000, stock: 1, color: '#ff6666', border: '#ff6666', bg: 'rgba(255,100,100,0.1)', locked: true }
        ];

        // 渲染商城商品
        function renderShopItems() {
            const shopGrid = document.querySelector('#shopModal .modal-body > div[style*="grid"]');
            if (!shopGrid) return;
            shopGrid.innerHTML = '';
            shopProducts.forEach((item, idx) => {
                let html = `
                <div class="shop-item" style="background:${item.bg};padding:15px;border:1px solid ${item.border};border-radius:5px;">
                    <h4 style="color:${item.color};">${item.name}</h4>
                    <p style="font-size:14px;margin:10px 0;">${item.desc || ''}</p>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${item.price}积分${typeof item.stock === 'number' ? ` | 库存:${item.stock}` : ''}</span>
                        ${
                            item.locked
                            ? `<button class="tool-button locked" style="padding:5px 10px;">未解锁</button>`
                            : `<button class="tool-button" style="padding:5px 10px;" onclick="editProduct(${idx})">编辑</button>`
                        }
                    </div>
                </div>
                `;
                shopGrid.insertAdjacentHTML('beforeend', html);
            });
        }

        // 显示上架商品弹窗
        function showAddProductModal() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        // 编辑商品弹窗
        let editingProductIndex = null;
        function editProduct(idx) {
            editingProductIndex = idx;
            const item = shopProducts[idx];
            document.getElementById('editProductName').value = item.name;
            document.getElementById('editProductDesc').value = item.desc || '';
            document.getElementById('editProductPrice').value = item.price;
            document.getElementById('editProductStock').value = typeof item.stock === 'number' ? item.stock : '';
            document.getElementById('editProductModal').style.display = 'block';
        }
        function saveEditProduct() {
            if (editingProductIndex === null) return;
            const price = parseInt(document.getElementById('editProductPrice').value);
            const stock = parseInt(document.getElementById('editProductStock').value);
            if (isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
                alert('请输入有效的价格和库存');
                return;
            }
            shopProducts[editingProductIndex].price = price;
            shopProducts[editingProductIndex].stock = stock;
            renderShopItems();
            closeModal('editProductModal');
        }

        // 添加新商品
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const price = parseInt(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            if (!name || isNaN(price) || isNaN(stock) || price <= 0 || stock < 0) {
                alert('请填写完整且有效的商品信息');
                return;
            }
            shopProducts.push({
                name,
                desc,
                price,
                stock,
                color: '#00ff88',
                border: '#00ff88',
                bg: 'rgba(0,255,136,0.1)'
            });
            renderShopItems();
            closeModal('addProductModal');
        }

        // 弹窗交互
        function showInfoControl() {
            document.getElementById('infoControlModal').style.display = 'block';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        function openShop() {
            document.getElementById('shopModal').style.display = 'block';
            renderShopItems();
        }
        // 其它弹窗和交互函数请参考副本文件，已同步
        // 隐藏真相
        function hideInfo() {
    alert('你选择隐藏部分真相，主角将无法获知关键线索。\n\n信任度-3，反噬值+5');
    if(typeof updateTrust === 'function') updateTrust(-3);
    if(typeof updateBacklash === 'function') updateBacklash(5);
}

// 误导主角
function mislead() {
    alert('你选择误导主角，剧情将偏离原有轨迹。\n\n信任度-8，反噬值+10');
    if(typeof updateTrust === 'function') updateTrust(-8);
    if(typeof updateBacklash === 'function') updateBacklash(10);
}

// 保持沉默
function staySilent() {
    alert('你选择保持沉默，主角将自行摸索。\n\n无消耗');
}
// 确认透露信息
function confirmInfoReveal() {
    const checkedBoxes = document.querySelectorAll('#infoControlModal input[type="checkbox"]:checked');
    if(checkedBoxes.length === 0) {
        alert('请至少选择一条信息');
        return;
    }
    // 执行信息透露
    let message = '【系统提示】\n';
    checkedBoxes.forEach(box => {
        switch(box.id) {
            case 'info1':
                message += '• 李长风看你的眼神有些异样，似乎在试探什么\n';
                break;
            case 'info2':
                message += '• 掌门此次召见并非偶然，而是一次精心安排的试探\n';
                break;
            case 'info3':
                message += '• 危险！掌门已经知道你身上有特殊之处\n';
                break;
            case 'info4':
                message += '• 警告！宗门内部并不安全，有外敌潜伏\n';
                break;
        }
    });
    alert(message);
    closeModal('infoControlModal');
    // 更新界面状态
    if(typeof updateTrust === 'function') updateTrust(5);
    if(typeof updatePoints === 'function') updatePoints(-200);
}
// 改价功能已废弃，相关函数移除

// 限时优惠
function createSale() {
    alert('限时优惠已开启：所有商品价格减半（演示效果）');
    document.querySelectorAll('.shop-item span').forEach(span => {
        let val = parseInt(span.textContent);
        if(!isNaN(val)) span.textContent = Math.floor(val / 2) + '积分';
    });
}

// 隐藏部分商品
function hideItems() {
    alert('部分商品已隐藏（演示效果）');
    const items = document.querySelectorAll('.shop-item');
    if(items.length > 2) items[2].style.display = 'none';
}

// 制造缺货假象
function createFakeUrgency() {
    alert('制造缺货假象：部分商品显示“缺货”标签（演示效果）');
    const items = document.querySelectorAll('.shop-item');
    if(items.length > 1) {
        let tag = document.createElement('span');
        tag.textContent = '缺货';
        tag.style.cssText = 'color:#ff4444;font-weight:bold;margin-left:10px;';
        items[1].appendChild(tag);
    }
}
// 暂停时间功能
// 查看时间锚点
function checkAnchors() {
    const anchorModal = document.createElement('div');
    anchorModal.className = 'modal';
    anchorModal.style.display = 'block';
    anchorModal.innerHTML = `
        <div class="modal-content" style="min-width: 700px;">
            <h2 class="modal-title">时间锚点管理</h2>
            <div class="modal-body">
                <div style="display: flex; gap: 20px; overflow-x: auto; padding: 20px 0;">
                    <div class="time-anchor" style="min-width: 150px; text-align: center; cursor: pointer;" onclick="confirmRewind(1)">
                        <div style="width: 100px; height: 100px; margin: 0 auto; background: rgba(0,255,136,0.2); border: 2px solid #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 24px;">📍</span>
                        </div>
                        <h4 style="margin-top: 10px;">初入青云</h4>
                        <p style="font-size: 12px; opacity: 0.7;">3天前</p>
                        <p style="font-size: 12px; color: #ffaa00;">反噬值: +20</p>
                    </div>
                    <div class="time-anchor" style="min-width: 150px; text-align: center; cursor: pointer;" onclick="confirmRewind(2)">
                        <div style="width: 100px; height: 100px; margin: 0 auto; background: rgba(0,255,136,0.2); border: 2px solid #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 24px;">📍</span>
                        </div>
                        <h4 style="margin-top: 10px;">剑法显露</h4>
                        <p style="font-size: 12px; opacity: 0.7;">1天前</p>
                        <p style="font-size: 12px; color: #ffaa00;">反噬值: +10</p>
                    </div>
                    <div class="time-anchor current" style="min-width: 150px; text-align: center;">
                        <div style="width: 100px; height: 100px; margin: 0 auto; background: rgba(255,255,0,0.2); border: 2px solid #ffff00; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 24px;">📌</span>
                        </div>
                        <h4 style="margin-top: 10px;">当前时间点</h4>
                        <p style="font-size: 12px; opacity: 0.7;">现在</p>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,0,0,0.2); border-radius: 5px;">
                    <strong>⚠️ 警告：</strong>时间回溯会留下痕迹，高感知NPC可能察觉异常。当前已回溯 <span style="color: #ff4444;">2</span> 次。
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="this.closest('.modal').remove()">关闭</button>
            </div>
        </div>
    `;
    document.body.appendChild(anchorModal);
}

// 确认时间回溯
function confirmRewind(anchorId) {
    if(confirm(`确定要回溯到这个时间点吗？\n\n这将：\n- 消耗大量积分\n- 增加世界反噬值\n- 可能被某些NPC察觉\n- 主角会保留部分记忆碎片`)) {
        alert('时间回溯中...\n\n【系统日志】\n时间线重构完成\n检测到3个时间疤痕\n警告：天机阁可能已察觉异常');
        if(typeof updateBacklash === 'function') {
            updateBacklash(anchorId === 1 ? 20 : 10);
        }
    }
}

// 查看系统日志
function viewLogs() {
    const logModal = document.createElement('div');
    logModal.className = 'modal';
    logModal.style.display = 'block';
    logModal.innerHTML = `
        <div class="modal-content" style="min-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 class="modal-title">系统日志</h2>
            <div class="modal-body">
                <div style="font-family: monospace; font-size: 14px; line-height: 1.6;">
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(0,255,136,0.1);">
                        <span style="color: #00ff88;">[10:23:45]</span> 系统启动，绑定主角：林凡
                    </div>
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(0,200,255,0.1);">
                        <span style="color: #00ccff;">[10:25:12]</span> 检测到关键剧情点：掌门召见
                    </div>
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(255,170,0,0.1);">
                        <span style="color: #ffaa00;">[10:25:33]</span> NPC李长风怀疑度上升至35%
                    </div>
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(255,0,0,0.1);">
                        <span style="color: #ff4444;">[10:26:01]</span> 警告：检测到魔门间谍活动
                    </div>
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(0,255,136,0.1);">
                        <span style="color: #00ff88;">[10:27:15]</span> 主角请求查看李长风属性 - 已响应
                    </div>
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,0,0.1);">
                        <span style="color: #ffff00;">[10:28:02]</span> 世界反噬值达到45，进入警戒状态
                    </div>
                    <div class="log-entry" style="margin-bottom: 10px; padding: 10px; background: rgba(255,0,255,0.1);">
                        <span style="color: #ff00ff;">[10:28:45]</span> 天机阁开始扫描异常波动
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="tool-button" onclick="filterLogs('all')">全部</button>
                    <button class="tool-button" onclick="filterLogs('system')">系统操作</button>
                    <button class="tool-button" onclick="filterLogs('world')">世界事件</button>
                    <button class="tool-button" onclick="filterLogs('danger')">危险警告</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="exportLogs()">导出日志</button>
                <button class="tool-button" onclick="this.closest('.modal').remove()">关闭</button>
            </div>
        </div>
    `;
    document.body.appendChild(logModal);
}

// 日志筛选（占位，实际可扩展）
function filterLogs(type) {
    alert('筛选功能仅为演示，实际可根据type参数筛选日志内容');
}

// 导出日志（占位，实际可扩展）
function exportLogs() {
    alert('导出功能仅为演示，实际可将日志内容导出为文件');
}
// 创建任务
/* 任务列表功能 */
let tasks = [
    // 示例任务
    // { name: "拜见掌门", desc: "前往主峰大殿", done: false }
];

function openTaskList() {
    // 构建任务列表HTML
    let listHtml = '';
    if (tasks.length === 0) {
        listHtml = '<div style="color:#888;text-align:center;margin:20px 0;">暂无任务</div>';
    } else {
        listHtml = '<ul style="list-style:none;padding:0;">' +
            tasks.map((t, i) => `
                <li style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                    <div>
                        <span style="font-weight:bold;color:${t.done ? '#7a8a99' : '#222'}">${t.name}</span>
                        <span style="color:#888;font-size:13px;margin-left:8px;">${t.desc || ''}</span>
                        ${t.reward ? `<span style="color:#bfa782;font-size:13px;margin-left:8px;">🎁${t.reward}</span>` : ''}
                        ${t.consequence ? `<span style="color:#ff4444;font-size:13px;margin-left:8px;">⚠${t.consequence}</span>` : ''}
                    </div>
                    <div>
                        <button class="tool-button" style="padding:3px 10px;font-size:13px;margin-right:8px;" onclick="toggleTaskDone(${i})">${t.done ? '已完成' : '未完成'}</button>
                        <button class="tool-button danger" style="padding:3px 10px;font-size:13px;" onclick="deleteTask(${i})">删除</button>
                    </div>
                </li>
            `).join('') +
            '</ul>';
    }

    // 新建任务表单
    let formHtml = `
        <div style="margin-top:20px;padding:10px 0;border-top:1px solid #eee;">
            <h3 style="margin-bottom:10px;color:#7a8a99;">发布新任务</h3>
            <div style="margin-bottom:8px;">
                <input type="text" id="newTaskName" placeholder="任务名称" style="width:100%;padding:6px;">
            </div>
            <div style="margin-bottom:8px;">
                <input type="text" id="newTaskDesc" placeholder="任务描述" style="width:100%;padding:6px;">
            </div>
            <div style="margin-bottom:8px;">
                <input type="text" id="newTaskReward" placeholder="奖励（如：100积分/洞察符x1）" style="width:100%;padding:6px;">
            </div>
            <div style="margin-bottom:8px;">
                <select id="newTaskConsequenceSelect" style="width:100%;padding:6px;" onchange="toggleConsequenceInput()">
                    <option value="">无</option>
                    <option value="增加NPC怀疑">增加NPC怀疑</option>
                    <option value="触发陷阱事件">触发陷阱事件</option>
                    <option value="改变势NPC好感">改变势NPC好感</option>
                    <option value="其他">其他</option>
                </select>
                <input type="text" id="newTaskConsequenceInput" placeholder="请输入特殊后果" style="width:100%;padding:6px;display:none;margin-top:6px;">
            </div>
            <button class="tool-button" style="width:100%;" onclick="addTask()">发布任务</button>
        </div>
    `;

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="min-width: 420px;max-width:90vw;">
            <h2 class="modal-title">任务列表</h2>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
                ${listHtml}
                ${formHtml}
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="this.closest('.modal').remove()">关闭</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function addTask() {
    const name = document.getElementById('newTaskName').value.trim();
    const desc = document.getElementById('newTaskDesc').value.trim();
    const reward = document.getElementById('newTaskReward').value.trim();
    const consequenceSelect = document.getElementById('newTaskConsequenceSelect');
    const consequenceInput = document.getElementById('newTaskConsequenceInput');
    let consequence = "";
    if (consequenceSelect.value === "其他") {
        consequence = consequenceInput.value.trim();
        if (!consequence) {
            alert('请填写特殊后果');
            return;
        }
    } else {
        consequence = consequenceSelect.value;
    }
    if (!name) {
        alert('请输入任务名称');
        return;
    }
    tasks.push({ name, desc, reward, consequence, done: false });
    document.querySelector('.modal').remove();
    openTaskList();
}
// 系统偷偷用积分功能
// 集成用途选择弹窗
function systemStealPoints() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="min-width:360px;">
            <h2 class="modal-title">系统偷偷用积分</h2>
            <div class="modal-body">
                <div style="margin-bottom:10px;">请选择要执行的系统专属操作：</div>
                <select id="stealPurpose" style="width:100%;padding:7px;margin-bottom:10px;">
                    <option value="剧情">暗中修改剧情走向</option>
                    <option value="障碍">制造主角意外或障碍</option>
                    <option value="other">其他（自定义说明）</option>
                </select>
                <select id="stealPurposeSub" style="width:100%;padding:7px;margin-bottom:10px;display:none;"></select>
                <input type="text" id="stealPurposeOther" style="width:100%;padding:7px;margin-bottom:10px;display:none;" placeholder="请输入自定义用途说明">
                <div style="margin-bottom:10px;">请输入要偷偷消耗的积分数量：</div>
                <input type="number" id="stealPointsInput" style="width:100%;padding:8px;" min="1" placeholder="如：100">
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="confirmStealPoints()">确定</button>
                <button class="tool-button" onclick="this.closest('.modal').remove()">取消</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // 二级选项数据
    const subOptions = {
        "剧情": [
            { v: "遇到关键NPC", t: "强制主角遇到关键NPC" },
            { v: "提前触发事件", t: "提前触发重要剧情事件" },
            { v: "阻断主线", t: "阻断主线/强制支线" },
            { v: "主角被误导", t: "主角被误导/走错路" }
        ],
        "障碍": [
            { v: "降低属性", t: "降低主角属性" },
            { v: "丢失道具", t: "主角丢失关键道具" },
            { v: "受伤生病", t: "主角受伤/生病" },
            { v: "被NPC针对", t: "被NPC针对/陷害" }
        ]
    };

    // 用途切换
    const purposeSel = modal.querySelector('#stealPurpose');
    const subSel = modal.querySelector('#stealPurposeSub');
    const otherInput = modal.querySelector('#stealPurposeOther');
    function updateSubOptions() {
        const v = purposeSel.value;
        if (v === '剧情' || v === '障碍') {
            subSel.style.display = '';
            subSel.innerHTML = subOptions[v].map(opt => `<option value="${opt.v}">${opt.t}</option>`).join('');
            otherInput.style.display = 'none';
        } else if (v === 'other') {
            subSel.style.display = 'none';
            otherInput.style.display = '';
        }
    }
    purposeSel.onchange = updateSubOptions;
    updateSubOptions();
}
function confirmStealPoints() {
    const val = parseInt(document.getElementById('stealPointsInput').value);
    const purposeSel = document.getElementById('stealPurpose');
    const subSel = document.getElementById('stealPurposeSub');
    let purpose = purposeSel ? purposeSel.value : '';
    let detail = '';
    if (purpose === '剧情' || purpose === '障碍') {
        detail = subSel && subSel.value ? subSel.options[subSel.selectedIndex].text : '';
    } else if (purpose === 'other') {
        detail = document.getElementById('stealPurposeOther').value.trim();
        if (!detail) {
            alert('请填写自定义用途说明');
            return;
        }
    }
    if (!val || val <= 0) {
        alert('请输入有效的积分数量');
        return;
    }
    let msg = '';
    if (purpose === '剧情' || purpose === '障碍') {
        msg = `系统已偷偷消耗 ${val} 积分，执行操作：${detail}`;
    } else {
        msg = `系统已偷偷消耗 ${val} 积分，执行了专属操作：${detail}`;
    }
    alert(msg);
    document.querySelector('.modal').remove();
    // 如需同步扣除积分，可在此处实现
}
// 在页面加载后给积分区域加入口
document.addEventListener('DOMContentLoaded', function() {
    const points = document.querySelector('.points-display');
    if (points && !document.getElementById('systemStealBtn')) {
        const btn = document.createElement('button');
        btn.id = 'systemStealBtn';
        btn.textContent = '系统偷偷用积分';
        btn.style.cssText = 'margin-left:12px;font-size:12px;padding:2px 10px;background:#7a8a99;color:#fff;border:none;border-radius:4px;cursor:pointer;opacity:0.5;transition:opacity 0.2s;';
        btn.onmouseenter = () => btn.style.opacity = '1';
        btn.onmouseleave = () => btn.style.opacity = '0.5';
        btn.onclick = systemStealPoints;
        points.appendChild(btn);
    }
});
// 头像上传与替换（仅前端临时）
let avatarData = {
    "主角": null,
    "李长风": null,
    "赵明": null
};

function setAvatar(name, el) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            avatarData[name] = evt.target.result;
            el.querySelector('.avatar-img').src = evt.target.result;
            el.querySelector('.avatar-text').style.display = 'none';
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

// 修改 viewStats 头像渲染
const oldViewStats = viewStats;
viewStats = function() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="min-width: 520px;max-width:95vw;">
            <h2 class="modal-title">属性详情</h2>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
                <div style="display:flex;gap:24px;flex-wrap:wrap;">
                    <!-- 主角卡片 -->
                    <div style="flex:1 1 220px;min-width:220px;max-width:320px;background:rgba(122,138,153,0.10);border:2px solid #7a8a99;border-radius:12px;box-shadow:0 2px 12px #7a8a9930;padding:20px 18px 16px 18px;display:flex;align-items:center;">
                        <div class="avatar-box" style="width:56px;height:56px;border-radius:50%;background:#7a8a99;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px #7a8a9950;font-size:26px;color:#fff;font-weight:bold;flex-shrink:0;cursor:pointer;position:relative;" title="点击更换头像">
                            <span class="avatar-text" style="user-select:none;">主角</span>
                            <img class="avatar-img" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;" />
                            <span style="position:absolute;right:2px;bottom:2px;font-size:13px;color:#fff;background:#0006;border-radius:50%;padding:0 3px;">✎</span>
                        </div>
                        <div style="margin-left:18px;flex:1;">
                            <div style="font-size:18px;font-weight:bold;color:#7a8a99;margin-bottom:2px;">主角（{char}）</div>
                            <div style="font-size:15px;margin-bottom:8px;color:#4d4d4d;">青云宗外门弟子</div>
                            <ul style="list-style:none;padding:0;margin:0 0 8px 0;font-size:14px;color:#444;">
                                <li>姓名：{char}</li>
                                <li>修为：炼气七层</li>
                                <li>天赋：剑道悟性极高</li>
                                <li>特殊：身负异宝</li>
                                <li>信任度：<span style="color:#7a8a99;font-weight:bold;">78%</span></li>
                            </ul>
                        </div>
                    </div>
                    <!-- NPC卡片 -->
                    <div style="flex:2 1 320px;min-width:220px;">
                        <div style="font-size:16px;color:#7a8a99;font-weight:bold;margin-bottom:8px;margin-top:8px;">NPC列表</div>
                        <div style="display:flex;gap:16px;flex-wrap:wrap;">
                            <div style="flex:1 1 180px;min-width:180px;max-width:220px;background:rgba(191,167,130,0.10);border:1.5px solid #bfa782;border-radius:10px;box-shadow:0 1px 6px #bfa78230;padding:14px 12px 10px 12px;display:flex;align-items:center;">
                                <div class="avatar-box" style="width:40px;height:40px;border-radius:50%;background:#bfa782;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 6px #bfa78250;font-size:16px;color:#fff;font-weight:bold;flex-shrink:0;cursor:pointer;position:relative;" title="点击更换头像">
                                    <span class="avatar-text" style="user-select:none;">李长</span>
                                    <img class="avatar-img" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;" />
                                    <span style="position:absolute;right:1px;bottom:1px;font-size:11px;color:#fff;background:#0006;border-radius:50%;padding:0 2px;">✎</span>
                                </div>
                                <div style="margin-left:12px;flex:1;">
                                    <div style="font-size:15px;font-weight:bold;color:#bfa782;">李长风 <span style="font-size:12px;color:#888;">（外门管事）</span></div>
                                    <ul style="list-style:none;padding:0;margin:0 0 2px 0;font-size:13px;color:#444;">
                                        <li>修为：筑基初期</li>
                                        <li>性格：严厉、谨慎</li>
                                        <li>对主角态度：警惕</li>
                                        <li>备注：已察觉主角异常</li>
                                    </ul>
                                </div>
                            </div>
                            <div style="flex:1 1 180px;min-width:180px;max-width:220px;background:rgba(122,138,153,0.10);border:1.5px solid #7a8a99;border-radius:10px;box-shadow:0 1px 6px #7a8a9930;padding:14px 12px 10px 12px;display:flex;align-items:center;">
                                <div class="avatar-box" style="width:40px;height:40px;border-radius:50%;background:#7a8a99;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 6px #7a8a9950;font-size:16px;color:#fff;font-weight:bold;flex-shrink:0;cursor:pointer;position:relative;" title="点击更换头像">
                                    <span class="avatar-text" style="user-select:none;">赵明</span>
                                    <img class="avatar-img" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;" />
                                    <span style="position:absolute;right:1px;bottom:1px;font-size:11px;color:#fff;background:#0006;border-radius:50%;padding:0 2px;">✎</span>
                                </div>
                                <div style="margin-left:12px;flex:1;">
                                    <div style="font-size:15px;font-weight:bold;color:#7a8a99;">赵明 <span style="font-size:12px;color:#888;">（内门执事）</span></div>
                                    <ul style="list-style:none;padding:0;margin:0 0 2px 0;font-size:13px;color:#444;">
                                        <li>修为：金丹中期</li>
                                        <li>性格：冷静、善于观察</li>
                                        <li>对主角态度：暗中关注</li>
                                        <li>备注：怀疑主角身份</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top:18px;color:#888;font-size:13px;">
                    当前系统：{user}
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="this.closest('.modal').remove()">关闭</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // 头像事件绑定
    const avatarMap = [
        { name: "主角", sel: ".modal .avatar-box:nth-of-type(1)" },
        { name: "李长风", sel: ".modal .avatar-box:nth-of-type(2)" },
        { name: "赵明", sel: ".modal .avatar-box:nth-of-type(3)" }
    ];
    avatarMap.forEach(({ name, sel }) => {
        const el = modal.querySelector(sel);
        if (!el) return;
        // 显示已上传头像
        if (avatarData[name]) {
            el.querySelector('.avatar-img').src = avatarData[name];
            el.querySelector('.avatar-img').style.display = '';
            el.querySelector('.avatar-text').style.display = 'none';
        }
        el.onclick = () => setAvatar(name, el);
    });
};
// 查看属性弹窗
function viewStats() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="min-width: 520px;max-width:95vw;">
            <h2 class="modal-title">属性详情</h2>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
                <div style="display:flex;gap:24px;flex-wrap:wrap;">
                    <!-- 主角卡片 -->
                    <div style="flex:1 1 220px;min-width:220px;max-width:320px;background:rgba(122,138,153,0.10);border:2px solid #7a8a99;border-radius:12px;box-shadow:0 2px 12px #7a8a9930;padding:20px 18px 16px 18px;display:flex;align-items:center;">
                        <div style="width:56px;height:56px;border-radius:50%;background:#7a8a99;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px #7a8a9950;font-size:26px;color:#fff;font-weight:bold;flex-shrink:0;">
                            主角
                        </div>
                        <div style="margin-left:18px;flex:1;">
                            <div style="font-size:18px;font-weight:bold;color:#7a8a99;margin-bottom:2px;">主角（{char}）</div>
                            <div style="font-size:15px;margin-bottom:8px;color:#4d4d4d;">青云宗外门弟子</div>
                            <ul style="list-style:none;padding:0;margin:0 0 8px 0;font-size:14px;color:#444;">
                                <li>姓名：{char}</li>
                                <li>修为：炼气七层</li>
                                <li>天赋：剑道悟性极高</li>
                                <li>特殊：身负异宝</li>
                                <li>信任度：<span style="color:#7a8a99;font-weight:bold;">78%</span></li>
                            </ul>
                        </div>
                    </div>
                    <!-- NPC卡片 -->
                    <div style="flex:2 1 320px;min-width:220px;">
                        <div style="font-size:16px;color:#7a8a99;font-weight:bold;margin-bottom:8px;margin-top:8px;">NPC列表</div>
                        <div style="display:flex;gap:16px;flex-wrap:wrap;">
                            <div style="flex:1 1 180px;min-width:180px;max-width:220px;background:rgba(191,167,130,0.10);border:1.5px solid #bfa782;border-radius:10px;box-shadow:0 1px 6px #bfa78230;padding:14px 12px 10px 12px;display:flex;align-items:center;">
                                <div style="width:40px;height:40px;border-radius:50%;background:#bfa782;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 6px #bfa78250;font-size:16px;color:#fff;font-weight:bold;flex-shrink:0;">
                                    李长
                                </div>
                                <div style="margin-left:12px;flex:1;">
                                    <div style="font-size:15px;font-weight:bold;color:#bfa782;">李长风 <span style="font-size:12px;color:#888;">（外门管事）</span></div>
                                    <ul style="list-style:none;padding:0;margin:0 0 2px 0;font-size:13px;color:#444;">
                                        <li>修为：筑基初期</li>
                                        <li>性格：严厉、谨慎</li>
                                        <li>对主角态度：警惕</li>
                                        <li>备注：已察觉主角异常</li>
                                    </ul>
                                </div>
                            </div>
                            <div style="flex:1 1 180px;min-width:180px;max-width:220px;background:rgba(122,138,153,0.10);border:1.5px solid #7a8a99;border-radius:10px;box-shadow:0 1px 6px #7a8a9930;padding:14px 12px 10px 12px;display:flex;align-items:center;">
                                <div style="width:40px;height:40px;border-radius:50%;background:#7a8a99;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 6px #7a8a9950;font-size:16px;color:#fff;font-weight:bold;flex-shrink:0;">
                                    赵明
                                </div>
                                <div style="margin-left:12px;flex:1;">
                                    <div style="font-size:15px;font-weight:bold;color:#7a8a99;">赵明 <span style="font-size:12px;color:#888;">（内门执事）</span></div>
                                    <ul style="list-style:none;padding:0;margin:0 0 2px 0;font-size:13px;color:#444;">
                                        <li>修为：金丹中期</li>
                                        <li>性格：冷静、善于观察</li>
                                        <li>对主角态度：暗中关注</li>
                                        <li>备注：怀疑主角身份</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top:18px;color:#888;font-size:13px;">
                    当前系统：{user}
                </div>
            </div>
            <div class="modal-actions">
                <button class="tool-button" onclick="this.closest('.modal').remove()">关闭</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// 下拉框切换显示输入框
function toggleConsequenceInput() {
    const select = document.getElementById('newTaskConsequenceSelect');
    const input = document.getElementById('newTaskConsequenceInput');
    if (select.value === "其他") {
        input.style.display = "";
    } else {
        input.style.display = "none";
        input.value = "";
    }
}

function toggleTaskDone(idx) {
    tasks[idx].done = !tasks[idx].done;
    document.querySelector('.modal').remove();
    openTaskList();
}

function deleteTask(idx) {
    if (confirm('确定要删除该任务吗？')) {
        tasks.splice(idx, 1);
        document.querySelector('.modal').remove();
        openTaskList();
    }
}
document.addEventListener('DOMContentLoaded', function() {
   var btn = document.getElementById('memoryEditBtn');
   if(btn) {
       btn.onclick = function() {
           var modal = document.getElementById('memoryEditModal');
           if(modal) modal.style.display = 'block';
       }
   }
});
// 自动隐藏关键剧情点提示
document.addEventListener('DOMContentLoaded', function() {
    var prompt = document.querySelector('.intervention-prompt');
    if(prompt) {
        prompt.style.opacity = '1';
        setTimeout(function() {
            prompt.style.opacity = '0';
            setTimeout(function() {
                prompt.style.display = 'none';
            }, 500);
        }, 3000);
    }
});
</script>
</body>
</html>
